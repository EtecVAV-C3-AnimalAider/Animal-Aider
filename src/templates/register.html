{% extends 'base.html' %}
{% block conteudo %}
    <form action="{{url_for('register')}}" method="POST" enctype="multipart/form-data">
        <div>
            <label for="name">Nome:</label>
            <input type="text" name="name" required/>
        </div>
        <div>
            <label for="email">Email:</label>
            <input type="email" name="email" required/>
        </div>
        <div>
            <label for="password">Senha:</label>
            <input type="password" name="password" required/>
        </div>
        <div>
            <label for="cep">CEP:</label>
            <input type="text" name="cep" id="cep" required/>
        </div>
        <div>
            <label for="city">Cidade: </label>
            <input type="text" name="city" id="city" required/>
        </div>
        <div>
            <label for="addr">Endereço:</label>
            <input type="text" id="addr" name="addr" required/>
        </div>
        <div>
            <label for="num">Número:</label>
            <input type="text" name="num" maxlength="12" required/>
        </div>
        <div>
            <label for="phone">Celular:</label>
            <input type="tel" name="phone" required>
        </div>
        <div>
            <label for="photo">Foto de perfil:</label>
            <input type="file" name="photo" required>
        </div>
        <button class="btn btn-success">Registrar</button>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cepInput = document.getElementById('cep');
            const addrInput = document.getElementById('addr');
            const citySelect = document.getElementById('city'); // Assumindo que é um select
            
            // Verifica se os elementos existem
            if (!cepInput) return;
            
            // Função para limpar campos
            function clearAddressFields() {
                if (addrInput) addrInput.value = '';
                if (citySelect) citySelect.value = '';
            }
            
            // Função para mostrar loading
            function showLoading(show = true) {
                if (addrInput) {
                    addrInput.style.backgroundColor = show ? '#f0f0f0' : '';
                    addrInput.placeholder = show ? 'Buscando endereço...' : '';
                    addrInput.disabled = show;
                }
            }
            
            // Função principal de busca CEP
            function searchCEP(cep) {
                // Limpa campos antes de buscar
                clearAddressFields();
                showLoading(true);
                
                fetch(`/get_address/${cep}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        showLoading(false);
                        
                        if (!data.erro) {
                            // Preenche endereço
                            if (addrInput && data.logradouro) {
                                addrInput.value = data.logradouro;
                            }
                            
                            // Preenche cidade (tratamento para select)
                            if (citySelect && data.localidade) {
                                // Se for um select, tenta encontrar a opção
                                if (citySelect.tagName.toLowerCase() === 'select') {
                                    const options = Array.from(citySelect.options);
                                    const cityOption = options.find(option => 
                                        option.value === data.localidade || 
                                        option.text === data.localidade
                                    );
                                    
                                    if (cityOption) {
                                        citySelect.value = cityOption.value;
                                    } else {
                                        console.warn(`Cidade "${data.localidade}" não encontrada no select`);
                                    }
                                } else {
                                    // Se for input normal
                                    citySelect.value = data.localidade;
                                }
                            }
                            
                            // Feedback visual de sucesso
                            cepInput.style.borderColor = '#4CAF50';
                            setTimeout(() => {
                                cepInput.style.borderColor = '';
                            }, 2000);
                            
                        } else {
                            // CEP não encontrado
                            showCepError('CEP não encontrado. Verifique o número digitado.');
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        console.error('Erro ao buscar CEP:', error);
                        showCepError('Erro ao buscar o endereço. Tente novamente.');
                    });
            }
            
            // Função para mostrar erros
            function showCepError(message) {
                cepInput.style.borderColor = '#ff4444';
                
                // Remove mensagem de erro anterior
                const existingError = cepInput.parentNode.querySelector('.cep-error');
                if (existingError) {
                    existingError.remove();
                }
                
                // Cria nova mensagem de erro
                const errorDiv = document.createElement('div');
                errorDiv.className = 'cep-error';
                errorDiv.textContent = message;
                errorDiv.style.cssText = `
                    color: #ff4444;
                    font-size: 12px;
                    margin-top: 5px;
                    display: block;
                `;
                
                cepInput.parentNode.appendChild(errorDiv);
                
                // Remove erro após 5 segundos
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                        cepInput.style.borderColor = '';
                    }
                }, 5000);
            }
            
            // Event listener para busca automática
            cepInput.addEventListener('blur', function() {
                const cep = this.value.replace(/\D/g, '');
                
                // Remove mensagens de erro anteriores
                const existingError = this.parentNode.querySelector('.cep-error');
                if (existingError) {
                    existingError.remove();
                }
                
                if (cep.length === 8) {
                    searchCEP(cep);
                } else if (cep.length > 0) {
                    showCepError('CEP deve ter 8 dígitos.');
                    clearAddressFields();
                }
            });
            
            // Busca em tempo real (opcional - descomente se quiser)
            /*
            let searchTimeout;
            cepInput.addEventListener('input', function() {
                const cep = this.value.replace(/\D/g, '');
                
                clearTimeout(searchTimeout);
                
                if (cep.length === 8) {
                    searchTimeout = setTimeout(() => {
                        searchCEP(cep);
                    }, 500); // Aguarda 500ms após parar de digitar
                } else {
                    clearAddressFields();
                }
            });
            */
        });
        </script>
        
        <style>
        .cep-error {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        
        #cep:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.3);
        }
        
        #addr[disabled] {
            background-color: #f0f0f0;
            cursor: wait;
        }
        </style>
{% endblock conteudo %}