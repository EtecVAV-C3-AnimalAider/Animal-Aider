{% extends 'base.html' %}
{% block conteudo %}
<div class="container my-5">
  <div class="p-4 bg-white rounded shadow-sm" style="max-width: 600px; margin: auto;">
    <form action="{{ url_for('rescue')}}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
      {% if session.get('logged') %}
        <input type="hidden" name="userId" value="{{ session.get('user_id') }}">
        <input type="hidden" name="author" value="{{ session.get('user_name') }}">
        <input type="hidden" name="phone" value="{{ session.get('user_phone') }}">
        <input type="hidden" name="cep" value="{{ session.get('user_cep') }}">
        <input type="hidden" name="city" value="{{ session.get('user_city') }}">
        <input type="hidden" name="address" value="{{ session.get('user_addr') }}">
        <input type="hidden" name="num" value="{{ session.get('user_num') }}">
      {% endif %}

      {% if not session.get('logged') %}
      <div class="mb-3">
        <label for="cep" class="form-label fw-semibold">CEP:</label>
        <input type="text" id="cep" name="cep" class="form-control" required>
        <div class="invalid-feedback">Por favor, informe o CEP.</div>
      </div>

      <div class="mb-3">
        <label for="addr" class="form-label fw-semibold">Endereço:</label>
        <input type="text" id="addr" name="addr" class="form-control" required>
        <div class="invalid-feedback">Informe o endereço.</div>
      </div>

      <div class="mb-3">
        <label for="num" class="form-label fw-semibold">Número:</label>
        <input type="text" id="num" name="num" class="form-control" required>
        <div class="invalid-feedback">Informe o número.</div>
      </div>

      <div class="mb-3">
        <label for="name" class="form-label fw-semibold">Autor:</label>
        <input type="text" id="name" name="name" class="form-control" required>
        <div class="invalid-feedback">Informe o nome do autor.</div>
      </div>

      <div class="mb-3">
        <label for="phone" class="form-label fw-semibold">Telefone para contato:</label>
        <input type="tel" id="phone" name="phone" class="form-control" required>
        <div class="invalid-feedback">Informe um telefone válido.</div>
      </div>

      <div class="mb-3">
        <label for="desc" class="form-label fw-semibold">Descrição:</label>
        <input type="text" id="desc" name="desc" class="form-control" required>
        <div class="invalid-feedback">Descreva a situação.</div>
      </div>

      <div class="mb-3">
        <label for="photo" class="form-label fw-semibold">Foto do animal:</label>
        <input type="file" id="photo" name="photo" class="form-control" accept="image/*" required>
        <div class="invalid-feedback">Anexe uma foto do animal.</div>
      </div>
      {% endif %}

      {% if session.get('logged') %}
      <div class="mb-3">
        <label for="desc" class="form-label fw-semibold">Descrição:</label>
        <textarea id="desc" name="desc" class="form-control" rows="4" required></textarea>
        <div class="invalid-feedback">Por favor, descreva a situação.</div>
      </div>

      <div class="mb-3">
        <label for="photo" class="form-label fw-semibold">Foto do animal (opcional):</label>
        <input type="file" id="photo" name="photo" class="form-control" accept="image/*">
      </div>
      {% endif %}

      <div class="text-center">
        <button type="submit" class="btn btn-primary px-5">Enviar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Validação Bootstrap
  (() => {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
  })();

  // Busca automática do endereço via CEP
  document.getElementById('cep')?.addEventListener('blur', function () {
    const cep = this.value.replace(/\D/g, '');

    if (cep.length === 8) {
      fetch(`/get_address/${cep}`)
        .then(res => res.json())
        .then(data => {
          if (!data.erro) {
            document.getElementById('addr').value = data.logradouro || '';
            // Se tiver um campo cidade visível, atualize aqui também:
            // document.getElementById('city').value = data.localidade || '';
          } else {
            alert('CEP não encontrado.');
          }
        })
        .catch(() => alert('Erro ao buscar o endereço.'));
    }
  });
</script>
{% endblock conteudo %}
