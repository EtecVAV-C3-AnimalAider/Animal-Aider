{% extends 'base_ong.html' %}
{% block ong_conteudo%}
<div class="container mt-4">
    <h2>Ações em Andamento</h2>
    
    <!-- Abas para Resgates e Denúncias -->
    <ul class="nav nav-tabs" id="ongoingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="rescues-tab" data-bs-toggle="tab" data-bs-target="#rescues" 
                    type="button" role="tab" aria-controls="rescues" aria-selected="true">
                Resgates <span class="badge bg-primary ms-2">{{ rescues.count() }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" 
                    type="button" role="tab" aria-controls="reports" aria-selected="false">
                Denúncias <span class="badge bg-warning ms-2">{{ reports.count() }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="ongoingTabsContent">
        <!-- Aba de Resgates -->
        <div class="tab-pane fade show active" id="rescues" role="tabpanel" aria-labelledby="rescues-tab">
            <div class="mt-3">
                {% if rescues.count() > 0 %}
                    <div class="row">
                        {% for rescue in rescues %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Resgate #{{ rescue.resc_id }}</h6>
                                    <span class="badge bg-{{ 'warning' if rescue.resc_status == 'aceito' else 'secondary' }}">
                                        {{ rescue.resc_status.title() }}
                                    </span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><strong>Autor:</strong> {{ rescue.resc_author }}</p>
                                    <p class="card-text"><strong>Telefone:</strong> {{ rescue.resc_phone }}</p>
                                    <p class="card-text"><strong>Cidade:</strong> {{ rescue.resc_city }}</p>
                                    {% if rescue.resc_addr %}
                                    <p class="card-text"><strong>Endereço:</strong> {{ rescue.resc_addr }}{% if rescue.resc_num %}, {{ rescue.resc_num }}{% endif %}</p>
                                    {% endif %}
                                    <p class="card-text"><strong>Descrição:</strong></p>
                                    <p class="card-text text-muted">{{ rescue.resc_desc[:100] }}{% if rescue.resc_desc|length > 100 %}...{% endif %}</p>
                                    <p class="card-text"><small class="text-muted">Criado em: {{ rescue.resc_date.strftime('%d/%m/%Y às %H:%M') }}</small></p>
                                    
                                    {% if rescue.resc_photo %}
                                    <div class="mb-3">
                                        <img src="{{ url_for('static', filename='uploads/' + rescue.resc_photo) }}" 
                                             class="img-thumbnail" style="max-width: 100px; max-height: 100px;" alt="Imagem do resgate">
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    {% if rescue.resc_status == 'aceito' %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                onclick="finishAction('rescue', {{ rescue.resc_id }})">
                                            <i class="bi bi-check-circle"></i> Finalizar Resgate
                                        </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-info btn-sm ms-2" data-bs-toggle="modal" 
                                            data-bs-target="#detailModal" onclick="showDetails('rescue', {{ rescue.resc_id }}, 
                                            '{{ rescue.resc_author }}', '{{ rescue.resc_city }}', 
                                            '{{ rescue.resc_desc }}', '{{ rescue.resc_date.strftime('%d/%m/%Y às %H:%M') }}',
                                            '{{ rescue.resc_photo or '' }}', '{{ rescue.resc_phone }}', '{{ rescue.resc_addr or '' }}', '{{ rescue.resc_num or '' }}')">>
                                        Ver Detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info mt-3" role="alert">
                        <i class="bi bi-info-circle"></i> Nenhum resgate em andamento no momento.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Aba de Denúncias -->
        <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
            <div class="mt-3">
                {% if reports.count() > 0 %}
                    <div class="row">
                        {% for report in reports %}
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Denúncia #{{ report.rep_id }}</h6>
                                    <span class="badge bg-{{ 'warning' if report.rep_status == 'aceito' else 'secondary' }}">
                                        {{ report.rep_status.title() }}
                                    </span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><strong>Título:</strong> {{ report.rep_title }}</p>
                                    <p class="card-text"><strong>Cidade:</strong> {{ report.rep_city }}</p>
                                    {% if report.rep_address %}
                                    <p class="card-text"><strong>Endereço:</strong> {{ report.rep_address }}</p>
                                    {% endif %}
                                    {% if report.rep_phone %}
                                    <p class="card-text"><strong>Telefone:</strong> {{ report.rep_phone }}</p>
                                    {% endif %}
                                    <p class="card-text"><strong>Descrição:</strong></p>
                                    <p class="card-text text-muted">{{ report.rep_desc[:100] }}{% if report.rep_desc|length > 100 %}...{% endif %}</p>
                                    <p class="card-text"><small class="text-muted">Criado em: {{ report.rep_date.strftime('%d/%m/%Y às %H:%M') }}</small></p>
                                    
                                    {% if report.rep_photo %}
                                    <div class="mb-3">
                                        <img src="{{ url_for('static', filename='uploads/' + report.rep_photo) }}" 
                                             class="img-thumbnail" style="max-width: 100px; max-height: 100px;" alt="Imagem da denúncia">
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    {% if report.rep_status == 'aceito' %}
                                        <button type="button" class="btn btn-success btn-sm" 
                                                onclick="finishAction('report', {{ report.rep_id }})">
                                            <i class="bi bi-check-circle"></i> Finalizar Denúncia
                                        </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-info btn-sm ms-2" data-bs-toggle="modal" 
                                            data-bs-target="#detailModal" onclick="showDetails('report', {{ report.rep_id }}, 
                                            '{{ report.rep_title }}', '{{ report.rep_city }}', 
                                            '{{ report.rep_desc }}', '{{ report.rep_date.strftime('%d/%m/%Y às %H:%M') }}',
                                            '{{ report.rep_photo or '' }}', '{{ report.rep_phone or '' }}', '{{ report.rep_address or '' }}', '')">>
                                        Ver Detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info mt-3" role="alert">
                        <i class="bi bi-info-circle"></i> Nenhuma denúncia em andamento no momento.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Detalhes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Tipo:</strong> <span id="modal-type"></span></p>
                        <p><strong>ID:</strong> <span id="modal-id"></span></p>
                        <p><strong>Título/Autor:</strong> <span id="modal-title"></span></p>
                        <p><strong>Cidade:</strong> <span id="modal-city"></span></p>
                        <p><strong>Telefone:</strong> <span id="modal-phone"></span></p>
                        <p><strong>Endereço:</strong> <span id="modal-address"></span></p>
                        <p><strong>Data:</strong> <span id="modal-date"></span></p>
                    </div>
                    <div class="col-md-6">
                        <div id="modal-image-container">
                            <img id="modal-image" class="img-fluid rounded" style="max-height: 300px;" alt="Imagem">
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Descrição:</strong></p>
                        <p id="modal-description" class="text-muted"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="modal-finish-btn" onclick="finishFromModal()">
                    Finalizar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
let currentAction = { type: '', id: '' };

function showDetails(type, id, title, city, description, date, image, phone, address, number) {
    currentAction = { type, id };
    
    document.getElementById('modal-type').textContent = type === 'rescue' ? 'Resgate' : 'Denúncia';
    document.getElementById('modal-id').textContent = '#' + id;
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-city').textContent = city;
    document.getElementById('modal-phone').textContent = phone || 'Não informado';
    
    // Para resgates, mostrar endereço completo; para denúncias, apenas o endereço
    if (type === 'rescue' && address) {
        document.getElementById('modal-address').textContent = address + (number ? ', ' + number : '');
    } else if (type === 'report' && address) {
        document.getElementById('modal-address').textContent = address;
    } else {
        document.getElementById('modal-address').textContent = 'Não informado';
    }
    
    document.getElementById('modal-description').textContent = description;
    document.getElementById('modal-date').textContent = date;
    
    const imageContainer = document.getElementById('modal-image-container');
    const modalImage = document.getElementById('modal-image');
    
    if (image && image !== '') {
        modalImage.src = '/static/uploads/' + image;
        imageContainer.style.display = 'block';
    } else {
        imageContainer.style.display = 'none';
    }
    
    document.getElementById('detailModalLabel').textContent = 
        `Detalhes do ${type === 'rescue' ? 'Resgate' : 'Denúncia'} #${id}`;
}

function finishFromModal() {
    if (currentAction.type && currentAction.id) {
        finishAction(currentAction.type, currentAction.id);
        // Fechar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('detailModal'));
        modal.hide();
    }
}

function finishAction(type, id) {
    const typeText = type === 'rescue' ? 'resgate' : 'denúncia';
    
    if (!confirm(`Tem certeza que deseja finalizar este ${typeText}?`)) {
        return;
    }

    // Desabilitar botão para evitar cliques múltiplos
    const buttons = document.querySelectorAll(`button[onclick*="finishAction('${type}', ${id})"]`);
    buttons.forEach(btn => btn.disabled = true);

    const url = `/finish_${type}/${id}`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // Remover o card da tela
            const card = document.querySelector(`button[onclick*="finishAction('${type}', ${id})"]`).closest('.col-md-6, .col-lg-4');
            if (card) {
                card.style.transition = 'opacity 0.5s ease-out';
                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove();
                    updateCounts();
                }, 500);
            }
        } else {
            showAlert(data.message, 'danger');
            // Reabilitar botões em caso de erro
            buttons.forEach(btn => btn.disabled = false);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao processar solicitação', 'danger');
        // Reabilitar botões em caso de erro
        buttons.forEach(btn => btn.disabled = false);
    });
}

function showAlert(message, type) {
    // Criar e mostrar alert do Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Inserir no topo da página
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remover após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function updateCounts() {
    // Contar cards restantes
    const rescueCount = document.querySelectorAll('#rescues .card').length;
    const reportCount = document.querySelectorAll('#reports .card').length;
    
    // Atualizar badges
    document.querySelector('#rescues-tab .badge').textContent = rescueCount;
    document.querySelector('#reports-tab .badge').textContent = reportCount;
}
</script>

<!-- Bootstrap Icons (opcional) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock ong_conteudo%}